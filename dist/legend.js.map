{"version":3,"sources":["../src/legend.js"],"names":["angular","kbn","$","module","directive","popoverSrv","$timeout","link","scope","elem","$container","firstRender","ctrl","panel","data","seriesList","i","events","on","series","color","render","getSeriesIndexForElement","el","parents","toggleSeries","e","currentTarget","index","seriesInfo","sortLegend","stat","legend","sort","sortDesc","openColorSelector","target","length","find","show","element","position","template","openOn","model","autoClose","toggleAxis","colorSelected","changeSeriesColor","legendType","empty","append","showValues","values","percentage","tableLayout","toggleClass","arrow","sortKey","header","valueName","_","sortBy","match","alias","parseInt","stats","reverse","total","hideEmpty","allIsNull","html","label","value","formatValue","pvalue","toFixed"],"mappings":"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","file":"legend.js","sourcesContent":["import angular from 'angular';\r\n//import _ from  'lodash';\r\nimport kbn from 'app/core/utils/kbn';\r\nimport $ from  'jquery';\r\nimport 'jquery.flot';\r\nimport 'jquery.flot.time';\r\n\r\nangular.module('grafana.directives').directive('piechartLegend', function(popoverSrv, $timeout) {\r\n  return {\r\n    link: function(scope, elem) {\r\n      var $container = $('<section class=\"graph-legend\"></section>');\r\n      var firstRender = true;\r\n      var ctrl = scope.ctrl;\r\n      var panel = ctrl.panel;\r\n      var data;\r\n      var seriesList;\r\n      var i;\r\n\r\n      ctrl.events.on('render', function() {\r\n        data = ctrl.series;\r\n        if (data) {\r\n          for(var i in data) {\r\n            data[i].color = ctrl.data[i].color;\r\n          }\r\n          render();\r\n        }\r\n      });\r\n\r\n      function getSeriesIndexForElement(el) {\r\n        return el.parents('[data-series-index]').data('series-index');\r\n      }\r\n\r\n      function toggleSeries(e) {\r\n        var el = $(e.currentTarget);\r\n        var index = getSeriesIndexForElement(el);\r\n        var seriesInfo = seriesList[index];\r\n        ctrl.toggleSeries(seriesInfo, e);\r\n      }\r\n\r\n      function sortLegend(e) {\r\n        var el = $(e.currentTarget);\r\n        var stat = el.data('stat');\r\n\r\n        if (stat !== panel.legend.sort) { panel.legend.sortDesc = null; }\r\n\r\n        // if already sort ascending, disable sorting\r\n        if (panel.legend.sortDesc === false) {\r\n          panel.legend.sort = null;\r\n          panel.legend.sortDesc = null;\r\n          ctrl.render();\r\n          return;\r\n        }\r\n\r\n        panel.legend.sortDesc = !panel.legend.sortDesc;\r\n        panel.legend.sort = stat;\r\n        ctrl.render();\r\n      }\r\n\r\n      function openColorSelector(e) {\r\n        // if we clicked inside poup container ignore click\r\n        if ($(e.target).parents('.popover').length) {\r\n          return;\r\n        }\r\n\r\n        var el = $(e.currentTarget).find('.fa-minus');\r\n        var index = getSeriesIndexForElement(el);\r\n        var series = seriesList[index];\r\n\r\n        $timeout(function() {\r\n          popoverSrv.show({\r\n            element: el[0],\r\n            position: 'bottom center',\r\n            template: '<gf-color-picker></gf-color-picker>',\r\n            openOn: 'hover',\r\n            model: {\r\n              autoClose: true,\r\n              series: series,\r\n              toggleAxis: function() {},\r\n              colorSelected: function(color) {\r\n                ctrl.changeSeriesColor(series, color);\r\n              }\r\n            },\r\n          });\r\n        });\r\n      }\r\n\r\n      function render() {\r\n        if(panel.legendType === 'On graph') {\r\n          $container.empty();\r\n          return;\r\n        }\r\n\r\n        if (firstRender) {\r\n          elem.append($container);\r\n          $container.on('click', '.graph-legend-icon', openColorSelector);\r\n          $container.on('click', 'th', sortLegend);\r\n          firstRender = false;\r\n        }\r\n\r\n        seriesList = data;\r\n\r\n        $container.empty();\r\n\r\n        var showValues = panel.legend.values || panel.legend.percentage;\r\n        var tableLayout = (\r\n            panel.legendType === 'Under graph' ||\r\n            panel.legendType === 'Right side'\r\n            ) && showValues;\r\n\r\n\r\n        $container.toggleClass('graph-legend-table', tableLayout);\r\n\r\n        if (tableLayout) {\r\n          var arrow = (sortKey) => {\r\n            if (panel.legend.sort === sortKey) {\r\n              return ' <span class=\"fa fa-caret-' + (panel.legend.sortDesc ? 'down' : 'up') + '\"></span>'\r\n            }\r\n            return '';\r\n          };\r\n          var header = '<tr><th class=\"pointer\" colspan=\"2\" style=\"text-align:left\" data-stat=\"series\">series' +\r\n            arrow('series') + '</th>';\r\n          if (panel.legend.values) {\r\n            header += '<th class=\"pointer\" data-stat=\"' + panel.valueName + '\">values' +\r\n              arrow(panel.valueName) + '</th>';\r\n          }\r\n          if (panel.legend.percentage) {\r\n            header += '<th class=\"pointer\">percentage</th>';\r\n          }\r\n          header += '</tr>';\r\n          $container.append($(header));\r\n        }\r\n\r\n        if (panel.legend.sort) {\r\n          seriesList = _.sortBy(seriesList, function(series) {\r\n            if (panel.legend.sort === 'series') {\r\n              var match = series.alias.match(/\\d+/);\r\n              if (match) {\r\n                return parseInt(match[0]);\r\n              } else {\r\n                return -1;\r\n              }\r\n            } else {\r\n              return series.stats[panel.legend.sort];\r\n            }\r\n          });\r\n          if (panel.legend.sortDesc) {\r\n            seriesList = seriesList.reverse();\r\n          }\r\n        }\r\n\r\n        if (panel.legend.percentage) {\r\n          var total = 0;\r\n          for (i = 0; i < seriesList.length; i++) {\r\n            total += seriesList[i].stats[ctrl.panel.valueName];\r\n          }\r\n        }\r\n\r\n        for (i = 0; i < seriesList.length; i++) {\r\n          var series = seriesList[i];\r\n\r\n          // ignore empty series\r\n          if (panel.legend.hideEmpty && series.allIsNull) {\r\n            continue;\r\n          }\r\n          // ignore series excluded via override\r\n          if (!series.legend) {\r\n            continue;\r\n          }\r\n\r\n          var html = '<div class=\"graph-legend-series';\r\n          html += '\" data-series-index=\"' + i + '\">';\r\n          html += '<span class=\"graph-legend-icon\" style=\"float:none;\">';\r\n          html += '<i class=\"fa fa-minus pointer\" style=\"color:' + series.color + '\"></i>';\r\n          html += '</span>';\r\n\r\n          html += '<span class=\"graph-legend-alias\" style=\"float:none;\">';\r\n          html += '<a>' + series.label + '</a>';\r\n          html += '</span>';\r\n\r\n          if (showValues && tableLayout) {\r\n            var value = series.formatValue(series.stats[ctrl.panel.valueName]);\r\n            if (panel.legend.values) {\r\n              html += '<div class=\"graph-legend-value\">' + ctrl.formatValue(value) + '</div>';\r\n            }\r\n            if (total) {\r\n              var pvalue = ((value / total) * 100).toFixed(2) + '%';\r\n              html += '<div class=\"graph-legend-value\">' + pvalue +'</div>';\r\n            }\r\n          }\r\n\r\n          html += '</div>';\r\n          $container.append($(html));\r\n        }\r\n      }\r\n    }\r\n  };\r\n});\r\n"]}